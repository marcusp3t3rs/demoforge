# E1-US1: Authentication Flow Diagrams

## 1. High-Level Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚  (Tenant    â”‚
â”‚   Admin)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Navigates to Dashboard
       â”‚    (Not authenticated)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DemoForge Dashboard           â”‚
â”‚   http://localhost:3000         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. Middleware detects no session
       â”‚    â†’ Redirect to /login
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Login Page                   â”‚
â”‚    - DemoForge branding         â”‚
â”‚    - "Sign in with Microsoft"   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. User clicks "Sign in with Microsoft"
       â”‚    â†’ signIn('azure-ad')
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Microsoft Entra ID                       â”‚
â”‚    https://login.microsoftonline.com            â”‚
â”‚                                                  â”‚
â”‚    4. User enters credentials                   â”‚
â”‚       - Email/username                          â”‚
â”‚       - Password                                â”‚
â”‚       - MFA (if enabled)                        â”‚
â”‚                                                  â”‚
â”‚    5. Consent to permissions (first time)       â”‚
â”‚       - User.Read (profile info)                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 6. Authorization Code returned
       â”‚    (via redirect to callback URL)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    NextAuth Callback Endpoint                   â”‚
â”‚    /api/auth/callback/azure-ad                  â”‚
â”‚                                                  â”‚
â”‚    7. Exchange code for tokens                  â”‚
â”‚       POST to token endpoint                    â”‚
â”‚       â†“                                          â”‚
â”‚    8. Receive tokens:                           â”‚
â”‚       - Access Token (1 hour)                   â”‚
â”‚       - Refresh Token (90 days)                 â”‚
â”‚       - ID Token (user info)                    â”‚
â”‚       â†“                                          â”‚
â”‚    9. Validate tokens (signature, expiry)       â”‚
â”‚       â†“                                          â”‚
â”‚   10. Extract user info from ID token:          â”‚
â”‚       - Name                                     â”‚
â”‚       - Email                                    â”‚
â”‚       - Tenant ID                                â”‚
â”‚       - Roles (if configured)                   â”‚
â”‚       â†“                                          â”‚
â”‚   11. Create session:                           â”‚
â”‚       - Store tokens server-side                â”‚
â”‚       - Create encrypted JWT cookie             â”‚
â”‚       - Set HTTP-only, Secure flags             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 12. Redirect to original URL
       â”‚     (or default dashboard)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Protected Dashboard                          â”‚
â”‚    - Header shows user name                     â”‚
â”‚    - Role badge displayed                       â”‚
â”‚    - Full dashboard access                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Subsequent Requests (Already Authenticated)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚ (Returning) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Navigates to Dashboard
       â”‚    (Has session cookie)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js Middleware                    â”‚
â”‚   - Reads session cookie                â”‚
â”‚   - Validates JWT signature             â”‚
â”‚   - Checks expiration                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€ Valid Session? â”€â”€â”€â”
       â”‚                       â”‚
       â–¼ YES                   â–¼ NO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Allow Access    â”‚    â”‚ Redirect to      â”‚
â”‚ to Dashboard    â”‚    â”‚ /login           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Token Refresh Flow (Future - E1-US6)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Dashboard Request                      â”‚
â”‚   - User performing action               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Server needs to call Graph API
       â”‚    (requires access token)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Server-side Token Check                â”‚
â”‚   - Retrieve access token from storage   â”‚
â”‚   - Check expiration                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€ Token Valid? â”€â”€â”€â”
       â”‚                    â”‚
       â–¼ YES                â–¼ NO (Expired)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Use Token   â”‚     â”‚ Refresh Token Flow           â”‚
â”‚ for API     â”‚     â”‚                              â”‚
â”‚ Call        â”‚     â”‚ 1. Retrieve refresh token    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ 2. POST to token endpoint    â”‚
                    â”‚ 3. Receive new access token  â”‚
                    â”‚ 4. Update stored tokens      â”‚
                    â”‚ 5. Use new token for API     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Sign-Out Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚  (Clicks    â”‚
â”‚ "Sign Out") â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. signOut() called
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   NextAuth Sign-Out Handler              â”‚
â”‚   /api/auth/signout                      â”‚
â”‚                                          â”‚
â”‚   2. Clear session cookie                â”‚
â”‚   3. Delete tokens from storage          â”‚
â”‚      (server-side)                       â”‚
â”‚   4. Optionally: Revoke tokens with      â”‚
â”‚      Entra ID (future)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. Redirect to login page
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Login Page                             â”‚
â”‚   - Session cleared                      â”‚
â”‚   - Ready for new sign-in                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Security Flow - Token Storage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Browser (Client-Side)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ONLY STORES:                                   â”‚
â”‚  âœ… Session Cookie (encrypted JWT)              â”‚
â”‚     - HTTP-only (no JS access)                  â”‚
â”‚     - Secure (HTTPS only in prod)               â”‚
â”‚     - SameSite=Lax (CSRF protection)            â”‚
â”‚                                                  â”‚
â”‚  Contains only:                                 â”‚
â”‚  - User ID                                      â”‚
â”‚  - User name                                    â”‚
â”‚  - User email                                   â”‚
â”‚  - Role (admin/user)                            â”‚
â”‚                                                  â”‚
â”‚  âŒ NEVER STORES:                               â”‚
â”‚     - Access tokens                             â”‚
â”‚     - Refresh tokens                            â”‚
â”‚     - ID tokens                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ HTTPS
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Server-Side (Next.js Backend)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  STORES IN MEMORY (MVP):                        â”‚
â”‚  âœ… Access Token                                â”‚
â”‚  âœ… Refresh Token                               â”‚
â”‚  âœ… ID Token                                    â”‚
â”‚                                                  â”‚
â”‚  STORES IN DATABASE (Future - E1-US3):          â”‚
â”‚  âœ… Encrypted access token                      â”‚
â”‚  âœ… Encrypted refresh token                     â”‚
â”‚  âœ… Token expiration timestamps                 â”‚
â”‚  âœ… User session metadata                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ HTTPS with Bearer Token
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Microsoft Graph API                       â”‚
â”‚       (Tenant Data Access)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser Tab                               â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  App Layout (SessionProvider)                      â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ Header                                        â”‚    â”‚
â”‚  â”‚  â”‚   - useSession() hook                           â”‚    â”‚
â”‚  â”‚  â”‚   - Display user info                           â”‚    â”‚
â”‚  â”‚  â”‚   - Sign out button                             â”‚    â”‚
â”‚  â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ Sidebar                                       â”‚    â”‚
â”‚  â”‚  â”‚   - Navigation links                            â”‚    â”‚
â”‚  â”‚  â”‚                                                  â”‚    â”‚
â”‚  â”‚  â””â”€â”€ Page Content                                  â”‚    â”‚
â”‚  â”‚      - Protected routes                            â”‚    â”‚
â”‚  â”‚      - Conditional rendering based on auth         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â–²                                  â”‚
â”‚                           â”‚                                  â”‚
â”‚                    Session Context                           â”‚
â”‚                (useSession hook data)                        â”‚
â”‚                           â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Next.js Server                            â”‚
â”‚                           â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Middleware (Route Protection)                     â”‚     â”‚
â”‚  â”‚  - Intercepts all requests                         â”‚     â”‚
â”‚  â”‚  - Checks session validity                         â”‚     â”‚
â”‚  â”‚  - Redirects unauthenticated users                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  API Routes: /api/auth/[...nextauth]              â”‚     â”‚
â”‚  â”‚  - signIn â†’ Redirect to Entra ID                  â”‚     â”‚
â”‚  â”‚  - callback â†’ Exchange code for tokens            â”‚     â”‚
â”‚  â”‚  - session â†’ Return current session               â”‚     â”‚
â”‚  â”‚  - signOut â†’ Clear session and tokens             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  NextAuth Configuration                            â”‚     â”‚
â”‚  â”‚  - Entra ID Provider setup                        â”‚     â”‚
â”‚  â”‚  - Session strategy (JWT)                         â”‚     â”‚
â”‚  â”‚  - Callbacks (jwt, session)                       â”‚     â”‚
â”‚  â”‚  - Token handling logic                           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ OAuth 2.0 / OIDC
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Microsoft Entra ID                              â”‚
â”‚              (Identity Provider)                             â”‚
â”‚                                                              â”‚
â”‚  - User authentication                                       â”‚
â”‚  - MFA enforcement                                           â”‚
â”‚  - Consent management                                        â”‚
â”‚  - Token issuance                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. File Structure After Implementation

```
dashboard/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚   â”‚       â””â”€â”€ [...nextauth]/
â”‚   â”‚   â”‚           â””â”€â”€ route.ts         â† NextAuth API handler
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx                 â† Login page with Microsoft button
â”‚   â”‚   â”œâ”€â”€ layout.tsx                   â† SessionProvider wrapper
â”‚   â”‚   â””â”€â”€ page.tsx                     â† Dashboard (protected)
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ layout/
â”‚   â”‚       â”œâ”€â”€ header.tsx               â† Updated with useSession()
â”‚   â”‚       â””â”€â”€ sidebar.tsx              â† Navigation (unchanged)
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.config.ts          â† NextAuth configuration
â”‚   â”‚   â”‚   â”œâ”€â”€ providers.ts            â† Entra ID provider
â”‚   â”‚   â”‚   â””â”€â”€ session.ts              â† Session utilities
â”‚   â”‚   â””â”€â”€ auth.tsx                     â† DEPRECATED (remove after migration)
â”‚   â”‚
â”‚   â””â”€â”€ middleware.ts                    â† Route protection logic
â”‚
â”œâ”€â”€ .env.example                         â† Template with auth variables
â”œâ”€â”€ .env.local                           â† Developer config (gitignored)
â””â”€â”€ package.json                         â† Add next-auth dependency
```

---

## 8. Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Initial Authentication                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Clicks       Browser          Next.js         Entra ID      Next.js       User
"Sign In"        Redirects         API Route       Auth Server    Callback     Logged In
   â”‚                â”‚                 â”‚                â”‚             â”‚            â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                 â”‚                â”‚             â”‚            â”‚
   â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                â”‚             â”‚            â”‚
   â”‚                â”‚ signIn('azure-ad')               â”‚             â”‚            â”‚
   â”‚                â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶             â”‚            â”‚
   â”‚                â”‚                 â”‚ Redirect with  â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚ client_id,     â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚ redirect_uri   â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
   â”‚                â”‚                 â”‚                â”‚ User     â”‚  â”‚            â”‚
   â”‚                â”‚                 â”‚                â”‚ Enters   â”‚  â”‚            â”‚
   â”‚                â”‚                 â”‚                â”‚ Creds    â”‚  â”‚            â”‚
   â”‚                â”‚                 â”‚                â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
   â”‚                â”‚                 â”‚                â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚   Auth Code    â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚   â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚            â”‚
   â”‚                â”‚                 â”‚                â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚ Forward code to callback     â”‚            â”‚
   â”‚                â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶            â”‚
   â”‚                â”‚                 â”‚                â”‚ Exchange code             â”‚
   â”‚                â”‚                 â”‚                â”‚ for tokens â”‚            â”‚
   â”‚                â”‚                 â”‚                â”‚ POST request             â”‚
   â”‚                â”‚                 â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶            â”‚
   â”‚                â”‚                 â”‚                â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚   Access Token,â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚   Refresh Tokenâ”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚   ID Token     â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚   â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚            â”‚
   â”‚                â”‚                 â”‚                â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚ Validate & Store             â”‚            â”‚
   â”‚                â”‚                 â”‚ Create session â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚ Set cookie     â”‚             â”‚            â”‚
   â”‚                â”‚                 â”‚                â”‚             â”‚            â”‚
   â”‚                â”‚   Redirect to dashboard          â”‚             â”‚            â”‚
   â”‚   â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚            â”‚
   â”‚                â”‚                 â”‚                â”‚             â”‚            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Authenticated API Requests                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Request    Browser        Middleware      NextAuth        Graph API
    â”‚              â”‚               â”‚               â”‚               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶               â”‚               â”‚               â”‚
    â”‚ GET /tenants â”‚               â”‚               â”‚               â”‚
    â”‚ Cookie: session_token         â”‚               â”‚               â”‚
    â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                â”‚               â”‚
    â”‚              â”‚ Check auth    â”‚               â”‚               â”‚
    â”‚              â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶               â”‚
    â”‚              â”‚               â”‚ Verify sessionâ”‚               â”‚
    â”‚              â”‚               â”‚               â”‚               â”‚
    â”‚              â”‚               â”‚ âœ“ Valid       â”‚               â”‚
    â”‚              â”‚               â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
    â”‚              â”‚ Allow request â”‚               â”‚               â”‚
    â”‚              â”‚               â”‚               â”‚               â”‚
    â”‚              â”‚  Route to handler (server-side)               â”‚
    â”‚              â”‚               â”‚               â”‚               â”‚
    â”‚              â”‚  Retrieve access token from storage           â”‚
    â”‚              â”‚               â”‚               â”‚               â”‚
    â”‚              â”‚  Make Graph API call with Bearer token        â”‚
    â”‚              â”‚               â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
    â”‚              â”‚               â”‚               â”‚ GET /v1.0/...  â”‚
    â”‚              â”‚               â”‚               â”‚ Authorization:  â”‚
    â”‚              â”‚               â”‚               â”‚ Bearer {token} â”‚
    â”‚              â”‚               â”‚               â”‚               â”‚
    â”‚              â”‚               â”‚               â”‚ JSON Response  â”‚
    â”‚              â”‚               â”‚               â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚               â”‚               â”‚               â”‚
    â”‚              â”‚  Return data to client        â”‚               â”‚
    â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
    â”‚ JSON Responseâ”‚               â”‚               â”‚               â”‚
    â”‚              â”‚               â”‚               â”‚               â”‚
```

---

## Key Security Features Illustrated

### ğŸ” Token Isolation
- **Browser:** Only session cookie (encrypted, HTTP-only)
- **Server:** All sensitive tokens (access, refresh, ID)
- **Never exposed:** Tokens never sent to browser JavaScript

### ğŸ›¡ï¸ Defense in Depth
1. **Middleware:** First line of defense (route protection)
2. **Session Validation:** Server-side JWT verification
3. **Token Validation:** Signature and expiration checks
4. **HTTPS:** Encrypted transport (production)
5. **Cookie Flags:** HTTP-only, Secure, SameSite

### ğŸ”„ Stateless by Default (MVP)
- JWT-based sessions (no database required initially)
- Scales horizontally
- Simple to implement
- Easy migration path to stateful sessions (E1-US3)

---

**Document Version:** 1.0  
**Last Updated:** 2025-11-12  
**Related:** [E1-US1 Full Proposal](e1-us1-tenant-admin-authentication.md)
